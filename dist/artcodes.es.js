import{loadOpencv as t}from"mirada";class e{constructor(t,e){this.streaming=!1,this.settings=null,this._constraints=t,e?this.video=e:(this.video=document.createElement("video"),this.video.muted=!0,this.video.playsInline=!0,this.video.style.display="none"),this.canvas=document.createElement("canvas"),this.canvas.style.display="none",document.body.append(this.video),document.body.append(this.canvas),this.context=this.canvas.getContext("2d"),this.mat=cv.Mat.zeros(10,10,cv.CV_8UC4),this.streaming=!1}get isStreaming(){return this.streaming}get constraints(){return this._constraints}set constraints(t){const e=this.streaming;this.stop(),this._constraints=t,e&&this.start()}get deviceId(){return this._deviceId}read(){this.context.drawImage(this.video,0,0,this.settings.width,this.settings.height);const t=this.context.getImageData(0,0,this.settings.width,this.settings.height);return this.mat.data.set(t.data),this.mat}async start(){this.stream=this.video.srcObject=await navigator.mediaDevices.getUserMedia(this._constraints);const t=this.settings=this.stream.getVideoTracks()[0].getSettings();console.log(t),this._deviceId=t.deviceId;const e=t.width,i=t.height;return this.video.width=e,this.video.height=i,await this.video.play(),this.canvas.width=e,this.canvas.height=i,this.mat=cv.Mat.zeros(i,e,cv.CV_8UC4),this.streaming=!0,t}stop(){var t;this.streaming&&(null==(t=this.stream)||t.getVideoTracks().forEach((t=>t.stop())),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.video.pause(),this.streaming=!1,this.mat.delete())}}class i{constructor(t,e,i){this.nodeIndex=t,this.regions=e,this.action=i}equals(t){return null!=t&&this.regions.length==t.regions.length&&this.regions.every((function(e,i){return e===t.regions[i]}))}}class s{constructor(t,e){this.code=t,this.action=e}}class n{constructor(t){this.experience=t;let e=Array(),i=20,n=1,r=20,a=1;this.embeddedChecksum=t.settings&&t.settings.embeddedChecksum||!1,t.actions.forEach((t=>{t.codes.forEach((o=>{const h=new s(o.split(":").map((t=>Number.parseInt(t))),t);e.push(h),r=Math.min(h.code.length,r),a=Math.max(h.code.length,a),h.code.forEach((t=>{i=Math.min(t,i),n=Math.max(t,n)}))}))})),this.ignoreEmpty=!0,this.codes=e,this.maxRegions=r,this.minRegions=a,this.maxValue=n,this.minValue=i}findMarker(t){for(let e=0;e<t.cols;++e){let i=this.createMarkerForNode(e,t);if(null!=i)return i}return null}static getFirstChild(t,e){return t.intPtr(0,e)[2]}static getNextNode(t,e){return t.intPtr(0,e)[0]}createMarkerForNode(t,e){let s=[],r=null,a=n.getFirstChild(e,t);for(;a>=0;){let t=n.countLeafs(a,e,this.minValue,this.maxValue);if(null!=t)if(0===t&&this.ignoreEmpty);else{if(s.length>=this.maxRegions)return null;s.push(t)}else{if(!this.embeddedChecksum||null!=r)return null;if(r=n.countChecksum(a,e),null==r)return null}a=n.getNextNode(e,a)}if(s.length<this.minRegions)return null;if(s.sort(),this.embeddedChecksum){if(null==r)return null;if(!n.isChecksumValid(s,r))return null}for(let n of this.codes){if(n.code.length==s.length&&n.code.every(((t,e)=>t===s[e])))return new i(t,s,n.action)}return null}static isChecksumValid(t,e){let i=0,s=1;return t.forEach((t=>{s%7==0&&s++,i+=t*s,s++})),e==(i-1)%7+1}static countChecksum(t,e){let i=n.getFirstChild(e,t);if(i<0)return null;let s=0;for(;i>=0;){if(!n.isValidHollowDot(i,e))return null;s++,i=n.getNextNode(e,i)}return s}static isValidHollowDot(t,e){let i=n.getFirstChild(e,t);return i>=0&&n.getNextNode(e,i)<0}static countLeafs(t,e,i,s){let r=0,a=n.getFirstChild(e,t);for(;a>=0;){if(n.getFirstChild(e,a)>=0)return null;if(r++,r>s)return null;a=n.getNextNode(e,a)}return r<i?0==r?0:null:r}}var r,a;function o(t){if(null==t)return new cv.Scalar(255,255,0,255);const e=function(t){if("#"==t.substr(0,1)){const e=(t.length-1)/3,i=[17,1,.062272][e-1];return[Math.round(parseInt(t.substr(1,e),16)*i),Math.round(parseInt(t.substr(1+e,e),16)*i),Math.round(parseInt(t.substr(1+2*e,e),16)*i)]}return t.split("(")[1].split(")")[0].split(",").map((t=>+t))}(t);return new cv.Scalar(e[0],e[1],e[2],255)}async function h(e,i){if("https:"!=location.protocol&&"localhost"!=location.hostname)throw new Error("Artcodes requires https in order to access camera");await t({opencvJsLocation:"opencv.js"});const s=new c(e,i);return"#play"==location.hash?await s.start():s.stop(),s}(a=r||(r={}))[a.loading=0]="loading",a[a.idle=1]="idle",a[a.scanning=2]="scanning";class c{constructor(t,i){var s;this._state=0,this.fps=10,this.tiles=1,this.detected=!1,this.currentMarker=null,this.selectListener=()=>{var t;this.camera.stop(),this.camera.constraints={video:{width:{min:600,ideal:800},height:{min:400,ideal:600},deviceId:null==(t=this.options.deviceSelect)?void 0:t.value}},this.start()},this.experience=t,this.options=i,this.detector=new n(t),this.camera=new e({video:{width:{min:600,ideal:1920},height:{min:400,ideal:1080},facingMode:"environment"},audio:!1},i.video),null==(s=i.stateChanged)||s.call(i,0),this.morphKernel=cv.Mat.ones(2,2,cv.CV_8U)}setState(t){var e,i;this._state=t,null==(i=(e=this.options).stateChanged)||i.call(e,t)}get state(){return this._state}async start(){var t,e,i,s,n,r,a;if(2!=this._state)try{const h=(null==(t=this.experience.settings)?void 0:t.actionTimout)||1e4,c=(null==(e=this.experience.settings)?void 0:e.threshSize)||201,l=(null==(i=this.experience.settings)?void 0:i.threshConst)||1,d=o(this.options.outlineColor),u=await this.camera.start(),v=new cv.Mat(u.width,u.height,cv.CV_8UC1);this.options.canvas.width=u.width,this.options.canvas.height=u.height;let g=0;if(null==(n=(s=this.options).stateChanged)||n.call(s,2),null==(a=(r=this.options).markerChanged)||a.call(r,null),this.options.useUrlHash&&history.replaceState(null,"","#play"),null!=this.options.deviceSelect){for(this.options.deviceSelect.removeEventListener("input",this.selectListener);this.options.deviceSelect.options.length>0;)this.options.deviceSelect.remove(0);const t=(await navigator.mediaDevices.enumerateDevices()).filter((t=>"videoinput"==t.kind));t.length>1&&(t.forEach((t=>{var e;const i=document.createElement("option");i.value=t.deviceId,i.innerHTML=t.label,null==(e=this.options.deviceSelect)||e.appendChild(i)})),null!=this.camera.deviceId&&(this.options.deviceSelect.value=this.camera.deviceId),this.options.deviceSelect.addEventListener("input",this.selectListener),this.options.deviceSelect.style.display="")}const m=()=>{var t,e,i,s;if(this.camera.isStreaming){const n=Date.now(),r=this.camera.read();if(cv.cvtColor(r,v,cv.COLOR_RGBA2GRAY),this.experience.settings&&!1===this.experience.settings.tile)cv.blur(v,v,new cv.Size(5,5)),cv.adaptiveThreshold(v,v,255,cv.ADAPTIVE_THRESH_MEAN_C,cv.THRESH_BINARY,c,l);else{this.detected||(this.tiles=this.tiles%9+1),cv.blur(v,v,new cv.Size(3,3));const t=u.width,e=u.height,i=Math.round(t/this.tiles),s=Math.round(e/this.tiles);for(let n=0;n<this.tiles;n++){const r=n*i,a=n===this.tiles-1?t-r:i;for(let t=0;t<this.tiles;t++){const i=t*s,n=t===this.tiles-1?e-i:s,o=v.roi(new cv.Rect(r,i,a,n));cv.threshold(o,o,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU)}}}const a=new cv.MatVector,o=new cv.Mat;cv.findContours(v,a,o,cv.RETR_TREE,cv.CHAIN_APPROX_SIMPLE),this.options.debugView?cv.cvtColor(v,v,cv.COLOR_GRAY2RGBA):r.copyTo(v);const p=this.detector.findMarker(o);null!=p?(this.detected=!0,p.equals(this.currentMarker)||(this.currentMarker=p,null==(e=(t=this.options).markerChanged)||e.call(t,p)),g=Date.now()+h,cv.drawContours(v,a,p.nodeIndex,d,2,cv.LINE_AA,o,100)):(this.detected=!1,null!=this.currentMarker&&0!=g&&Date.now()>g&&(g=0,this.currentMarker=p,null==(s=(i=this.options).markerChanged)||s.call(i,null))),"user"==u.facingMode&&cv.flip(v,v,1),cv.imshow(this.options.canvas,v);const f=1e3/this.fps-(Date.now()-n);setTimeout(m,f)}else v.delete(),this.setState(1)};m()}catch(h){console.log("error: ",h.message,h.name),console.trace(h),this.stop()}}stop(){this.options.useUrlHash&&history.replaceState(null,""," "),this.camera.stop(),this.setState(1)}}export{r as ScannerState,h as createScanner};
