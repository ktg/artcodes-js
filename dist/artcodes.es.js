import{loadOpencv as t}from"mirada";class e{constructor(t,e){this.streaming=!1,this.settings=null,this._constraints=t,e?this.video=e:(this.video=document.createElement("video"),this.video.muted=!0,this.video.playsInline=!0,this.video.style.display="none"),this.canvas=document.createElement("canvas"),this.canvas.style.display="none",document.body.append(this.video),document.body.append(this.canvas),this.context=this.canvas.getContext("2d"),this.mat=cv.Mat.zeros(10,10,cv.CV_8UC4),this.streaming=!1}get isStreaming(){return this.streaming}get constraints(){return this._constraints}set constraints(t){const e=this.streaming;this.stop(),this._constraints=t,e&&this.start()}get deviceId(){return this._deviceId}read(){this.context.drawImage(this.video,0,0,this.settings.width,this.settings.height);const t=this.context.getImageData(0,0,this.settings.width,this.settings.height);return this.mat.data.set(t.data),this.mat}async start(){this.stream=this.video.srcObject=await navigator.mediaDevices.getUserMedia(this._constraints);const t=this.settings=this.stream.getVideoTracks()[0].getSettings();this._deviceId=t.deviceId;const e=t.width,s=t.height;return this.video.width=e,this.video.height=s,await this.video.play(),this.canvas.width=e,this.canvas.height=s,this.mat=cv.Mat.zeros(s,e,cv.CV_8UC4),this.streaming=!0,t}stop(){var t;this.streaming&&(null==(t=this.stream)||t.getVideoTracks().forEach((t=>t.stop())),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.video.pause(),this.streaming=!1,this.mat.delete())}}class s{constructor(t,e,s){this.nodeIndex=t,this.regions=e,this.action=s}equals(t){return null!=t&&this.regions.length==t.regions.length&&this.regions.every((function(e,s){return e===t.regions[s]}))}}class i{constructor(t,e){this.code=t,this.action=e}}class n{constructor(t){this.experience=t;let e=Array(),s=20,n=1,a=20,o=1;this.embeddedChecksum=t.settings&&t.settings.embeddedChecksum||!1,t.actions.forEach((t=>{t.codes.forEach((r=>{const c=new i(r.split(":").map((t=>Number.parseInt(t))),t);e.push(c),a=Math.min(c.code.length,a),o=Math.max(c.code.length,o),c.code.forEach((t=>{s=Math.min(t,s),n=Math.max(t,n)}))}))})),this.codes=e,this.maxRegions=a,this.minRegions=o,this.maxValue=n,this.minValue=s}findMarker(t){for(let e=0;e<t.cols;++e){let s=this.createMarkerForNode(e,t);if(null!=s)return s}return null}static getFirstChild(t,e){return t.intPtr(0,e)[2]}static getNextNode(t,e){return t.intPtr(0,e)[0]}createMarkerForNode(t,e){let i=[],a=null,o=n.getFirstChild(e,t);for(;o>=0;){let t=n.countLeafs(o,e,this.minValue,this.maxValue);if(null!=t){if(i.length>=this.maxRegions)return null;i.push(t)}else{if(!this.embeddedChecksum||null!=a)return null;if(a=n.countChecksum(o,e),null==a)return null}o=n.getNextNode(e,o)}if(i.length<this.minRegions)return null;if(i.sort(),this.embeddedChecksum){if(null==a)return null;if(!n.isChecksumValid(i,a))return null}for(let n of this.codes){if(n.code.length==i.length&&n.code.every(((t,e)=>t===i[e])))return new s(t,i,n.action)}return null}static isChecksumValid(t,e){let s=0,i=1;return t.forEach((t=>{i%7==0&&i++,s+=t*i,i++})),e==(s-1)%7+1}static countChecksum(t,e){let s=n.getFirstChild(e,t);if(s<0)return null;let i=0;for(;s>=0;){if(!n.isValidHollowDot(s,e))return null;i++,s=n.getNextNode(e,s)}return i}static isValidHollowDot(t,e){let s=n.getFirstChild(e,t);return s>=0&&n.getNextNode(e,s)<0}static countLeafs(t,e,s,i){let a=0,o=n.getFirstChild(e,t);for(;o>=0;){if(n.getFirstChild(e,o)>=0)return null;if(a++,a>i)return console.log("Leaf count too high:"+a),null;o=n.getNextNode(e,o)}return a<s?null:a}}var a,o;function r(t){if(null==t)return new cv.Scalar(255,255,0,255);const e=function(t){if("#"==t.substr(0,1)){const e=(t.length-1)/3,s=[17,1,.062272][e-1];return[Math.round(parseInt(t.substr(1,e),16)*s),Math.round(parseInt(t.substr(1+e,e),16)*s),Math.round(parseInt(t.substr(1+2*e,e),16)*s)]}return t.split("(")[1].split(")")[0].split(",").map((t=>+t))}(t);return new cv.Scalar(e[0],e[1],e[2],255)}async function c(e,s){if("https:"!=location.protocol&&"localhost"!=location.hostname)throw new Error("Artcodes requires https in order to access camera");await t({opencvJsLocation:"opencv.js"});const i=new h(e,s);return"#play"==location.hash?await i.start():i.stop(),i}(o=a||(a={}))[o.loading=0]="loading",o[o.idle=1]="idle",o[o.scanning=2]="scanning";class h{constructor(t,s){var i;this._state=0,this.fps=10,this.currentMarker=null,this.selectListener=()=>{var t;this.camera.stop(),this.camera.constraints={video:{deviceId:null==(t=this.options.deviceSelect)?void 0:t.value}},this.start()},this.experience=t,this.options=s,this.detector=new n(t),this.camera=new e({video:{facingMode:"environment"},audio:!1},s.video),null==(i=s.stateChanged)||i.call(s,0)}setState(t){var e,s;this._state=t,null==(s=(e=this.options).stateChanged)||s.call(e,t)}get state(){return this._state}async start(){var t,e,s,i,n,a,o;if(2!=this._state)try{const c=(null==(t=this.experience.settings)?void 0:t.actionTimout)||5e3,h=(null==(e=this.experience.settings)?void 0:e.threshSize)||101,l=(null==(s=this.experience.settings)?void 0:s.threshConst)||1,d=r(this.options.outlineColor),u=await this.camera.start(),v=new cv.Mat(u.width,u.height,cv.CV_8UC1);this.options.canvas.width=u.width,this.options.canvas.height=u.height;let g=0;if(null==(n=(i=this.options).stateChanged)||n.call(i,2),null==(o=(a=this.options).markerChanged)||o.call(a,null),this.options.useUrlHash&&history.replaceState(null,"","#play"),null!=this.options.deviceSelect){for(this.options.deviceSelect.removeEventListener("input",this.selectListener);this.options.deviceSelect.options.length>0;)this.options.deviceSelect.remove(0);const t=(await navigator.mediaDevices.enumerateDevices()).filter((t=>"videoinput"==t.kind));t.length>1&&(t.forEach((t=>{var e;const s=document.createElement("option");s.value=t.deviceId,s.innerHTML=t.label,null==(e=this.options.deviceSelect)||e.appendChild(s)})),null!=this.camera.deviceId&&(this.options.deviceSelect.value=this.camera.deviceId),this.options.deviceSelect.addEventListener("input",this.selectListener),this.options.deviceSelect.style.display="")}const m=()=>{var t,e,s,i;if(this.camera.isStreaming){const n=Date.now(),a=this.camera.read();cv.cvtColor(a,v,cv.COLOR_RGBA2GRAY),cv.adaptiveThreshold(v,v,255,cv.ADAPTIVE_THRESH_MEAN_C,cv.THRESH_BINARY,h,l);let o=cv.Mat.ones(2,2,cv.CV_8U);cv.morphologyEx(v,v,cv.MORPH_OPEN,o);const r=new cv.MatVector,p=new cv.Mat;cv.findContours(v,r,p,cv.RETR_TREE,cv.CHAIN_APPROX_SIMPLE),this.options.debugView?cv.cvtColor(v,v,cv.COLOR_GRAY2RGBA):a.copyTo(v);const f=this.detector.findMarker(p);null!=f?(f.equals(this.currentMarker)||(this.currentMarker=f,null==(e=(t=this.options).markerChanged)||e.call(t,f)),g=Date.now()+c,cv.drawContours(v,r,f.nodeIndex,d,2,cv.LINE_AA,p,100)):null!=this.currentMarker&&0!=g&&Date.now()>g&&(g=0,this.currentMarker=f,null==(i=(s=this.options).markerChanged)||i.call(s,null)),"user"==u.facingMode&&cv.flip(v,v,1),cv.imshow(this.options.canvas,v);const C=1e3/this.fps-(Date.now()-n);setTimeout(m,C)}else v.delete(),this.setState(1)};m()}catch(c){console.log("error: ",c.message,c.name),console.trace(c),this.stop()}}stop(){this.options.useUrlHash&&history.replaceState(null,""," "),this.camera.stop(),this.setState(1)}}export{a as ScannerState,c as createScanner};
