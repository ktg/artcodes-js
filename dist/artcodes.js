Object.defineProperty(exports,"__esModule",{value:!0});var t=require("mirada");class e{constructor(t,e,s){this.streaming=!1,this._constraints=s,this.video=t,this.cap=new cv.VideoCapture(t),this.canvas=e,this.mat=cv.Mat.zeros(10,10,cv.CV_8UC4),this.streaming=!1}get isStreaming(){return this.streaming}get constraints(){return this._constraints}set constraints(t){const e=this.streaming;this.stop(),this._constraints=t,e&&this.start()}get deviceId(){return this._deviceId}read(){return this.cap.read(this.mat),this.mat}async start(){this.stream=this.video.srcObject=await navigator.mediaDevices.getUserMedia(this._constraints);const t=this.stream.getVideoTracks()[0].getSettings();this._deviceId=t.deviceId;const e=t.width,s=t.height;return this.video.width=e,this.video.height=s,await this.video.play(),this.canvas.width=e,this.canvas.height=s,this.mat=cv.Mat.zeros(s,e,cv.CV_8UC4),this.streaming=!0,{width:e,height:s,shouldFlip:"user"==t.facingMode}}stop(){var t,e;this.streaming&&(null===(t=this.stream)||void 0===t||t.getVideoTracks().forEach((t=>t.stop())),null===(e=this.canvas.getContext("2d"))||void 0===e||e.clearRect(0,0,this.canvas.width,this.canvas.height),this.video.pause(),this.streaming=!1,this.mat.delete())}}class s{constructor(t,e,s){this.nodeIndex=t,this.regions=e,this.action=s}equals(t){return null!=t&&this.regions.length==t.regions.length&&this.regions.every((function(e,s){return e===t.regions[s]}))}}class i{constructor(t,e){this.code=t,this.action=e}}class n{constructor(t){this.experience=t;let e=Array(),s=20,n=1,r=20,a=1;t.actions.forEach((t=>{t.codes.forEach((o=>{const c=new i(o.split(":").map((t=>Number.parseInt(t))),t);e.push(c),r=Math.min(c.code.length,r),a=Math.max(c.code.length,a),c.code.forEach((t=>{s=Math.min(t,s),n=Math.max(t,n)}))}))})),this.codes=e,this.maxRegions=r,this.minRegions=a,this.maxValue=n,this.minValue=s}findMarker(t){for(let e=0;e<t.cols;++e){let s=this.createMarkerForNode(e,t);if(null!=s)return s}return null}static getFirstChild(t,e){return t.intPtr(0,e)[2]}static getNextNode(t,e){return t.intPtr(0,e)[0]}createMarkerForNode(t,e){let i=[],r=n.getFirstChild(e,t);for(;r>=0;){let t=this.countLeafs(r,e);if(null==t)return null;if(i.length>=this.maxRegions)return null;i.push(t),r=n.getNextNode(e,r)}if(i.length<this.minRegions)return null;i.sort();for(let e of this.codes){if(e.code.length==i.length&&e.code.every(((t,e)=>t===i[e])))return new s(t,i,e.action)}return null}countLeafs(t,e){let s=0,i=n.getFirstChild(e,t);for(;i>=0;){if(n.getFirstChild(e,i)>=0)return null;if(s++,s>this.maxValue)return null;i=n.getNextNode(e,i)}return s<this.minValue?null:s}}var r;exports.ScannerState=void 0,(r=exports.ScannerState||(exports.ScannerState={}))[r.loading=0]="loading",r[r.idle=1]="idle",r[r.scanning=2]="scanning";class a{constructor(t,s){var i;this._state=exports.ScannerState.loading,this.fps=10,this.currentMarker=null,this.color=new cv.Scalar(255,255,0),this.selectListener=()=>{var t;this.camera.stop(),this.camera.constraints={video:{deviceId:null===(t=this.options.deviceSelect)||void 0===t?void 0:t.value}},this.start()},this.experience=t,this.options=s,this.detector=new n(t),this.camera=new e(s.video,s.canvas,{video:{facingMode:"environment"},audio:!1}),null===(i=s.stateChanged)||void 0===i||i.call(s,exports.ScannerState.loading)}setState(t){var e,s;this._state=t,null===(s=(e=this.options).stateChanged)||void 0===s||s.call(e,t)}get state(){return this._state}async start(){var t,e,s,i,n,r,a;if(this._state!=exports.ScannerState.scanning)try{const o=(null===(t=this.experience.settings)||void 0===t?void 0:t.actionTimout)||5e3,c=(null===(e=this.experience.settings)||void 0===e?void 0:e.threshSize)||101,h=(null===(s=this.experience.settings)||void 0===s?void 0:s.threshConst)||1,l=await this.camera.start(),d=new cv.Mat(l.width,l.height,cv.CV_8UC1);let v=0;if(null===(n=(i=this.options).stateChanged)||void 0===n||n.call(i,exports.ScannerState.scanning),null===(a=(r=this.options).markerChanged)||void 0===a||a.call(r,null),this.options.useUrlHash&&history.replaceState(null,"","#play"),null!=this.options.deviceSelect){for(this.options.deviceSelect.removeEventListener("input",this.selectListener);this.options.deviceSelect.options.length>0;)this.options.deviceSelect.remove(0);const t=(await navigator.mediaDevices.enumerateDevices()).filter((t=>"videoinput"==t.kind));t.length>1&&(t.forEach((t=>{var e;const s=document.createElement("option");s.value=t.deviceId,s.innerHTML=t.label,null===(e=this.options.deviceSelect)||void 0===e||e.appendChild(s)})),null!=this.camera.deviceId&&(this.options.deviceSelect.value=this.camera.deviceId),this.options.deviceSelect.addEventListener("input",this.selectListener),this.options.deviceSelect.style.display="")}const u=()=>{var t,e,s,i;if(this.camera.isStreaming){const n=Date.now(),r=this.camera.read();cv.cvtColor(r,d,cv.COLOR_RGBA2GRAY),cv.adaptiveThreshold(d,d,255,cv.ADAPTIVE_THRESH_MEAN_C,cv.THRESH_BINARY,c,h);const a=new cv.MatVector,p=new cv.Mat;cv.findContours(d,a,p,cv.RETR_TREE,cv.CHAIN_APPROX_SIMPLE),this.options.debugView?cv.cvtColor(d,d,cv.COLOR_GRAY2RGB):cv.cvtColor(r,d,cv.COLOR_RGBA2RGB);const g=this.detector.findMarker(p);null!=g?(g.equals(this.currentMarker)||(this.currentMarker=g,null===(e=(t=this.options).markerChanged)||void 0===e||e.call(t,g)),v=Date.now()+o,cv.drawContours(d,a,g.nodeIndex,this.color,2,cv.LINE_8,p,100)):null!=this.currentMarker&&0!=v&&Date.now()>v&&(v=0,this.currentMarker=g,null===(i=(s=this.options).markerChanged)||void 0===i||i.call(s,null)),l.shouldFlip&&cv.flip(d,d,1),cv.imshow(this.options.canvas,d);const m=1e3/this.fps-(Date.now()-n);setTimeout(u,m)}else d.delete(),this.setState(exports.ScannerState.idle)};u()}catch(t){console.log("error: ",t.message,t.name),console.trace(t),this.stop()}}stop(){this.options.useUrlHash&&history.replaceState(null,""," "),this.camera.stop(),this.setState(exports.ScannerState.idle)}}exports.Marker=s,exports.Scanner=a,exports.createScanner=async function(e,s){if("https:"!=location.protocol&&"localhost"!=location.hostname)throw new Error("Artcodes requires https in order to access camera");let i="/opencv.js";document.querySelectorAll("script").forEach((t=>{const e=t.src.indexOf("/main.");e>0&&(i=t.src.slice(0,e)+"/opencv.js")})),await t.loadOpencv({opencvJsLocation:i});const n=new a(e,s);return"#play"==location.hash?await n.start():n.stop(),n};
